<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WordGriddle</title>
    <meta name="description"
        content="WordGriddle is a word search puzzle using a grid of letters and a list of words to find. Fun challenge.">
    <meta name="apple-mobile-web-app-title" content="WordGriddle">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="48x48">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" title="WordGriddle">
    <link rel="icon" href="/favicon-96x96.png" type="image/png" sizes="96x96">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="stylesheet" href="style.css">
    <link rel="canonical" href="https://wordgriddle.com" />
    <!-- <script src="logger.js"></script> -->
    <script src="database.js"></script>
    <script src="theme.js"></script>
    <script src="script.js" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // As a URL shortening, look for a special request parameter
            // e.g. https://wordgriddle.com/?p=puzzle-1
            // If found, go straight to that puzzle - otherwise do the normal homepage thing
            const urlParams = new URLSearchParams(window.location.search);
            const puzzle = decodeURIComponent(urlParams.get(`p`) || '');
            if (puzzle.length) {
                window.location.replace(`puzzle.html?p=${puzzle}`);
                return;
            }

            // Assume we're loading from the default repo as this is the main page
            let repository = 'puzzles';
            let puzzleCatalog = `/assets/puzzles/catalog.json`;
            let puzzleUrlLink = `puzzle.html?p=%name`;

            fetch(puzzleCatalog)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error status: ${response.status}`);
                    }

                    return response.json();
                })
                .then(async data => {
                    // Work out the range of the set of puzzles in the catalog
                    let minPuzzleId = 999999;
                    let maxPuzzleId = 0;
                    data.puzzles.forEach(puzzle => {
                        minPuzzleId = Math.min(minPuzzleId, puzzle.id);
                        maxPuzzleId = Math.max(maxPuzzleId, puzzle.id);
                    });

                    if (maxPuzzleId < minPuzzleId) {
                        // No puzzles
                        return;
                    }
                    
                    // Get all known puzzle statuses for the set of puzzles in which we are interested
                    // We could do this piecemeal, puzzle by puzzle as required, but that is multiple database
                    // calls and this is just one, so take the slight hit in complexity/readability for performance
                    const statusList = await dbGetPuzzleStatusInRange(minPuzzleId, maxPuzzleId);

                    // Build the puzzle selector buttons
                    const puzzleListElement = document.getElementById('puzzle-list');
                    data.puzzles.forEach(async puzzle => {
                        // See if we have any stored status for this specific puzzle
                        let status = null;
                        if (statusList) {
                            statusList.forEach((statusObject) => {
                                if (statusObject.id == puzzle.id) {
                                    status = statusObject;
                                }
                            });
                        }

                        const puzzleSelector = await createPuzzleSelector(puzzle, status);

                        puzzleSelector.addEventListener('click', function () {
                            window.location.href = puzzleUrlLink
                                .replace("%name", encodeURIComponent(puzzle.name));
                        });

                        puzzleListElement.appendChild(puzzleSelector);
                    });
                })
                .catch(async error => {
                    console.error(`Failed to load puzzle list: '${puzzleCatalog}'`, error);
                    await openMessageBox(`Failed to load puzzle list.`, MessageBoxType.ERROR);

                    // Go back to the home page
                    window.location.href = "/";
                });
        });
    </script>
</head>

<body>
    <nav class="navbar">
        <!-- Product icon and name (protruding above and below the navbar) -->
        <a href="/" class="product-container">
            <div class="product-icon">
                <img src="/assets/icon-64-purple.png" width="64" height="64" alt="WordGriddle" class="top-left-icon">
            </div>
            <span class="product-name">WordGriddle</span>
        </a>

        <div class="navbar-right">
            <button class="toolbar-button" id="aboutBoxButton">
                <svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'
                    class="toolbar-button-icon" stroke='currentColor' fill='none' stroke-width='2'
                    stroke-linecap='round' stroke-linejoin='round'>
                    <path d='M12 3A9 9 0 0 1 12 21A9 9 0 0 1 12 3M12 10L12 17M12 7L12 7' />
                </svg>
            </button>
            <button class="toolbar-button" id="settingsButton">
                <svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'
                    class="toolbar-button-icon" stroke='currentColor' fill='none' stroke-width='2'
                    stroke-linecap='round' stroke-linejoin='round'>
                    <path fill='none' stroke='none' d='M0 0h24v24H0z' />
                    <path
                        d='M6 4V14M6 18V20M12 4V6M12 10V20M18 4V14M18 18V20M6 14A2 2 0 0 1 6 18A2 2 0 0 1 6 14M12 6A2 2 0 0 1 12 10A2 2 0 0 1 12 6M18 14A2 2 0 0 1 18 18A2 2 0 0 1 18 14' />
                </svg>
            </button>
            <button class="toolbar-button" id="themeToggleButton">
                <svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'
                    class="toolbar-button-icon" stroke='currentColor' fill='none' stroke-width='2'
                    stroke-linecap='round' stroke-linejoin='round'>
                    <path
                        d='M3 12H4M12 3V4M21 12H20M12 21V20M5.63 5.63L6.343 6.343M18.364 18.364L17.65 17.65M18.364 5.6L17.65 6.343M5.6 18.364L6.343 17.65M12 8A4 4 0 0 1 12 16A4 4 0 0 1 12 8' />
                </svg>
            </button>
        </div>
    </nav>

    <div class="panel">
        <div class="inner-panel">
            <h1>Welcome to WordGriddle!</h1>
            <div class="inner-panel borderless">
                <p class="paragraph">
                    Unleash your inner wordsmith with our captivating word search puzzle game!
                </p>
                <p class="paragraph">
                    This game was created by, and for, fans of games like Boggle and <a
                        href="https://squaredle.app/">Squaredle</a> and
                    offers a classic word grid challenge, guaranteed to provide hours of brain-teasing fun.
                </p>
                <p class="paragraph">
                    Start with our <a href="puzzle.html?p=puzzle-1">demo puzzle</a>!
                </p>
            </div>

            <div class="panel" style="width: 100%; height: fit-content;">
                <div class="inner-panel">
                    <h3>Choose a puzzle to play!</h3>
                    <div id="puzzle-list" class="button-container"></div>
                </div>
            </div>

            <div class="inner-panel borderless">
                <p class="paragraph">This is an early version of our game. It should work just fine, but please forgive
                    anything that goes wrong.</p>
                <p class="paragraph">Have fun, and please give us feedback and ideas for your own puzzles!</p>
                <p class="paragraph note info">Hint: Use the button at the top-right of the screen to switch between
                    light
                    and dark mode.</p>
                <p class="paragraph note caution">Note: The game will save your progress as you play each puzzle, but in
                    this version, how long your results are
                    stored might vary depending on the device on which you play the game.</p>
            </div>
            <hr>
            <div class="button-bar">
                <div id="puzzle-categories"></div>
            </div>
        </div>
    </div>

    <dialog id="aboutBoxDialog">
        <div class="icon">
            <img src="/assets/icon-32-purple.png" width="32" height="32" alt="WordGriddle" class="top-left-icon">
        </div>
        <div id="aboutBoxText">
        </div>
        <button type="button" id="aboutBoxOkButton">OK</button>
    </dialog>

    <dialog id="confirmationDialog">
        <form method="dialog">
            <p id="dialogMessage">Are you sure?</p>
            <button type="submit" value="yes">Yes</button>
            <button type="button" id="noButton">No</button>
        </form>
    </dialog>

    <dialog id="settingsDialog">
        <h3>Settings</h3>
        <div id="settingsControlArea">
            <button type="button" id="resetStorage"
                style="margin: 20px; background-color: var(--icon-error-color);">Reset Storage</button>
        </div>
        <button type="button" id="settingsOkButton">OK</button>
    </dialog>
</body>

</html>